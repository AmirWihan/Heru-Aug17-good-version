
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read their own profile.
    // Creation is allowed for any authenticated user.
    // Updates are restricted to the user themselves.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Admins have full read/write access to all collections for management.
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.authRole == 'admin';
    }

    // Check if the requesting user is a member of the firm that owns the resource.
    function isFirmMember(firmName) {
      let userFirmName = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.firmName;
      return userFirmName == firmName;
    }

    // Check if the user has Admin access level within their firm.
    function isFirmAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accessLevel == 'Admin';
    }
    
    // Clients can only be accessed by members of their assigned firm or by Super Admins.
    match /clients/{clientId} {
      allow read, write: if isSuperAdmin() || isFirmMember(resource.data.firmName);
    }

    // Leads can be accessed by members of the assigned firm or Super Admins.
    match /leads/{leadId} {
      allow read, write: if isSuperAdmin() || isFirmMember(resource.data.firmName);
    }
    
    // Tasks can be accessed by the assigned user or members of the client's firm.
    match /tasks/{taskId} {
      allow read, write: if isSuperAdmin() || request.auth.uid == resource.data.assignedTo.uid || isFirmMember(resource.data.client.firmName);
    }

    // All other collections are locked down by default unless explicitly allowed.
    // Example for a 'notifications' collection
    match /notifications/{notificationId} {
      allow read: if request.auth != null; // Allow all authenticated users to read notifications
      allow write: if isSuperAdmin(); // Only admins can create/update notifications
    }
  }
}
